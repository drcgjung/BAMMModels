#
# Copyright (c) 2021 T-Systems International GmbH (Catena-X Consortium)
# Copyright (c) 2021 Robert Bosch Manufacturing Solutions GmbH
#
# See the AUTHORS file(s) distributed with this work for additional
# information regarding authorship.
#
# See the LICENSE file(s) distributed with this work for
# additional information regarding license terms.
#

#################################################################################################################
# Github Workflow Implementing the Catena-X Modelling Governance Process
#################################################################################################################
# The following secrets are expected to be set
#################################################################################################################
# The following preconditions need to be made
##################################################################################################################

# name of workflow (as well as subordinate workflows and jobs) start with a "run-level" such that we can
# depend on them in order to implement workflow dependencies
name: 0 Governance

##############################################################
# Should trigger upon pushs (and pull requests? and dispatch?)
##############################################################

on: [push]

###############################################################
# Consists of two jobs, the first determines the environment
# and the second one (doing the real work) only triggers
# if such an environment can be detected (else the workflow is
# green without doing something)
###############################################################

jobs:

  ########################################
  # First job to determine the environment
  ########################################

  environment:
    # name of the job starts with a "run-level" subordinate to the workflow such that we can
    # depend on them in order to implement workflow dependencies
    name: 00 Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      stage: ${{ steps.setvars.outputs.stage }}
      workspace: ${{ steps.setvars.outputs.workspace }}
      workspace_uppercase: ${{ steps.setvars.outputs.workspace_uppercase }}
      status: ${{ steps.setvars.outputs.status }}

    steps:
      - name: Set variables
        id: setvars
        run: |
          if [[ "${{github.repository}}" == catenax/BAMMmodels ]]; then
             if [[ "${{github.ref}}" == refs/heads/governance-development ]]; then
                echo "Determined STAGING (dev|DRAFT)"
                echo "::set-output name=stage::STAGING"
                echo "::set-output name=workspace::dev042"
                echo "::set-output name=workspace_uppercase::DEV042"
                echo "::set-output name=status::-draft"
             elif [[ "${{github.ref}}" == refs/heads/main ]]; then
                echo "Determined STAGING (dev|RELEASED)"
                echo "::set-output name=stage::STAGING"
                echo "::set-output name=workspace::dev042"
                echo "::set-output name=workspace_uppercase::DEV042"
                echo "::set-output name=status::-release"
             else
                echo "Determined DEVELOPMENT (dev|DRAFT)"
                echo "::set-output name=stage::DEVELOPMENT"
                echo "::set-output name=workspace::dev042"
                echo "::set-output name=workspace_uppercase::DEV042"
                echo "::set-output name=status::-draft"
             fi
          else 
              echo "Unsupported Stage/Environment/Repository. Ommiting next job."
          fi
  
  ##########################################
  # Second job does the real deployment
  ##########################################
 
  deploy:
    # name of the job starts with a "run-level" subordinate to the workflow such that we can
    # depend on them in order to implement workflow dependencies
    name: 09 Deploy Semantic Models
    runs-on: ubuntu-latest
    # rely on the first job
    needs: environment
    # rely on successful detection of the workspace, ignore if empty
    if: ${{needs.environment.outputs.workspace}}
    # Set important environment vars
    env:
      STAGE: ${{needs.environment.outputs.stage}}
      WORKSPACE: ${{needs.environment.outputs.workspace}}
      WORKSPACE_UPPERCASE: ${{needs.environment.outputs.workspace_uppercase}}
      STATUS: ${{needs.environment.outputs.status}}
      SEMANTIC_HUB: catenax${{needs.environment.outputs.workspace}}akssrv.germanywestcentral.cloudapp.azure.com/semantics/hub/api/v1/models
      PUBLISHER: Catena-X Modelling Governance Body
      IDP_URL: catenax${{needs.environment.outputs.workspace}}akssrv.germanywestcentral.cloudapp.azure.com/iamcentralidp/auth/realms/CX-Central/protocol/openid-connect/token
    steps:

    # Analyze the commit
    - name: Check Changes
      id: changes
      uses: jitterbit/get-changed-files@v1
      with:
        # Format of the steps output context.
        # Can be 'space-delimited', 'csv', or 'json'.
        # Default: 'space-delimited'
        format: 'json'

    # get the latest sources
    - name: Checkout
      uses: actions/checkout@v2

    # enable execution of scripts
    - name: Execution Permission
      run: |
           chmod 777 .github/*.sh
    
    - name: Fetch Access Token
      id: token_request
      env:
        CLIENT_ID: ${{ secrets[format('IDP_CLIENT_ID_{0}', env.WORKSPACE_UPPERCASE)] }}
        CLIENT_SECRET: ${{ secrets[format('IDP_CLIENT_SECRET_{0}', env.WORKSPACE_UPPERCASE)] }}
      run: |
        response=$(curl --request POST \
        --url "https://$IDP_URL" \
        --header 'content-type: application/x-www-form-urlencoded' \
        --data-urlencode grant_type=client_credentials \
        --data-urlencode client_id=$CLIENT_ID \
        --data-urlencode client_secret=$CLIENT_SECRET )
        access_token=$( echo $response | jq -r '.access_token' )

        echo "ACCESS_TOKEN=$access_token" >> $GITHUB_ENV
        
    - name: Synchronize
      uses: ./.github/actions/synchronize
      with:
        ADDED: ${{ steps.changes.outputs.added }}
        MODIFIED: ${{ steps.changes.outputs.modified }}
        REMOVED:  ${{ steps.changes.outputs.removed }}
        RENAMED: ${{ steps.changes.outputs.renamed  }}
        BRANCH: ${{ github.ref }}

